<BsForm
  {{did-insert this.initializeData}}
  {{did-update this.initializeData @dataset}}
  @formLayout='vertical'
  @model={{this.formModel}}
  @onSubmit={{perform this.submit}}
  as |form|
>
  <form.element
    @controlType='power-select'
    @label='Pivot type'
    @property='pivotType'
    @options={{this.formModel.pivotTypeOptions}}
    as |el|
  >
    <el.control @searchEnabled={{true}} required />
  </form.element>
  <form.element
    @controlType='power-select-multiple'
    @label='Label Path'
    @property='labelPath'
    @options={{this.formModel.labelPathOptions}}
    as |el|
  >
    <el.control
      @searchPlaceholder='Please select a label property'
      @placeholder='Please select a label property'
      @searchEnabled={{true}}
    />
  </form.element>
  <form.element @controlType='label'>
    Tag paths
    <small class='text-secondary'>(optional)</small><BsTooltip @renderInPlace={{true}} @placement="top">Configure paths
      to tags that can be used in the search filter.</BsTooltip></form.element>

  {{#each-in this.formModel.keywordFilter as |keywordPathKey|}}
    <form.element
      @model={{this.formModel.keywordFilter}}
      @controlType='power-select-multiple'
      @property={{keywordPathKey}}
      @options={{this.formModel.labelPathOptions}}
      as |el|
    >
      <div class='input-group'>
        <div class='input-group-prepend'>
          <BsButton
            @type='secondary'
            @outline={{true}}
            aria-label='Close'
            @onClick={{fn this.removeKeywordFilter keywordPathKey}}
          >
            <span aria-hidden='true'>&times;</span>
          </BsButton>
        </div>
        {{!-- template-lint-disable no-inline-styles --}}
        <el.control
          @onChange={{fn this.keywordFilterChanged keywordPathKey}}
          @placeholder='Add filter keyword path'
          @searchEnabled={{true}}
         {{! this is needed because of a bug in ember-bootstrap }}
         style='flex-grow: 1'
        />
      </div>
    </form.element>
  {{/each-in}}
  <form.element
    @controlType='power-select-multiple'
    @property='newKeywordPath'
    @options={{this.formModel.labelPathOptions}}
    @onChange={{this.keywordFilterAdded}}
    as |el|
  >
    <el.control
      @placeholder='Add filter keyword path'
      @searchEnabled={{true}}
    />
  </form.element>
  <form.element
    @controlType='textarea'
    @label='SPARQL filter query'
    @property='filter'
    @customError={{if this.filterErrorMessage "Filter Query Failed"}}
    @helpText="Enter a SPARQL expression to filter the entities before unifying them. Use full URIs without prefixes. The entity is available as variable ?entity. "
    as |el|
  >
    <div class="input-group">
      <el.control class="font-monospace"
      placeholder="# Enter a sparql query e.g.:
FILTER NOT EXISTS {?entity <http://www.w3.org/2002/07/owl#deprecated> &quot;true&quot; .}"
      />
      <BsButton
        @outline={{true}}
        @type="success"
        @onClick={{this.testFilter}}
        @defaultText="Test"
        @pendingText="Testing..." />
    </div>
  </form.element>
  {{#each this.filterCountInputs as |filterInput| }}
    {{#let (await (filter-count-input-get-task filterInput)) as |task|}}
      <BsAlert @type="secondary" @onDismiss={{fn this.deleteModel filterInput}}>
        <:header>
          Performing filter test...{{#if task}} <TaskStatus @task={{task}} @onTaskFinished={{this.reloadFilterIO}} /> {{/if}}
        </:header>
        <:body>
          <dl>
            <dt>Pivot entitiy:</dt>
            <dd>{{filterInput.sourceClass}}</dd>
            <dt>Label path:</dt>
            <dd>{{filterInput.sourcePathString}}</dd>
            <dt>SPARQL Filter:</dt>
            <dd class="font-monospace">{{filterInput.sourceFilter}}</dd>
          </dl>
        </:body>
      </BsAlert>
    {{/let}}
  {{/each}}
  {{#each this.filterCountOutputs as |filterOutput| }}
    <BsAlert @type={{filterOutput.status}} @onDismiss={{fn this.deleteModel filterOutput}}>
      <:header>
        Filter Test Result:
      </:header>
      <:body>
        <dl>
          {{#if (or filterOutput.count (eq filterOutput.count 0))}}
            <dt>Count:</dt>
            <dd>{{filterOutput.count}}</dd>
          {{/if}}
          {{#if filterOutput.warning}}
            <dt>Warning:</dt>
            <dd>{{filterOutput.warning}}</dd>
          {{/if}}
          {{#if filterOutput.error}}
            <dt>Error:</dt>
            <dd>{{filterOutput.error}}</dd>
          {{/if}}
          {{#if filterOutput.query}}
            <details>
              <summary class="fw-bold">Query:</summary>
              <pre class="card card-body bg-light text-body mt-2">{{filterOutput.query}}</pre>
            </details>
          {{/if}}
        </dl>
      </:body>
    </BsAlert>
  {{/each}}
  <form.submitButton
    disabled={{or (not (and this.formModel.labelPath this.formModel.pivotType)) this.submit.isRunning}}
  >{{#if this.submit.isRunning}}Updating...{{else if @nodeShape}}Update{{else}}Submit{{/if}}</form.submitButton>
</BsForm>
